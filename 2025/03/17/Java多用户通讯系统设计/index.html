<!DOCTYPE html>


<html theme="dark" showBanner="true" hasBanner="true" > 
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet">
<link href="https://cdn.staticfile.org/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet">
<script src="/js/color.global.min.js" ></script>
<script src="/js/load-settings.js" ></script>
<head>
  <meta charset="utf-8">
  
  
  

  
  <title>Java多用户通讯系统设计 | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="preload" href="/css/fonts/Roboto-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
  <link rel="preload" href="/css/fonts/Roboto-Bold.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <meta name="description" content="多用户通信系统设计https:&#x2F;&#x2F;github.com&#x2F;thrinisty&#x2F;Multi-user-communication-system.git 功能实现1.用户登录 2.拉取用户列表 3.私聊 4.群聊 5.发文件 思路分析当客户端与服务端产生链接的时候，服务端会产生一个socket，必须要创建一个线程来持有并管理产生的socket 服务器端的多个线程需要一个管理线程的集合，用以后续的服务器推">
<meta property="og:type" content="article">
<meta property="og:title" content="Java多用户通讯系统设计">
<meta property="og:url" content="http://example.com/2025/03/17/Java%E5%A4%9A%E7%94%A8%E6%88%B7%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="多用户通信系统设计https:&#x2F;&#x2F;github.com&#x2F;thrinisty&#x2F;Multi-user-communication-system.git 功能实现1.用户登录 2.拉取用户列表 3.私聊 4.群聊 5.发文件 思路分析当客户端与服务端产生链接的时候，服务端会产生一个socket，必须要创建一个线程来持有并管理产生的socket 服务器端的多个线程需要一个管理线程的集合，用以后续的服务器推">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/66.png">
<meta property="og:image" content="http://example.com/images/67.png">
<meta property="og:image" content="http://example.com/images/68.png">
<meta property="og:image" content="http://example.com/images/69.png">
<meta property="og:image" content="http://example.com/images/70.png">
<meta property="og:image" content="http://example.com/images/71.png">
<meta property="og:image" content="http://example.com/images/72.png">
<meta property="article:published_time" content="2025-03-17T07:08:00.000Z">
<meta property="article:modified_time" content="2025-04-21T08:21:09.961Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/66.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: light)" href="/images/favicon-light-192.png" sizes="192x192">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-32.png" sizes="32x32">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-128.png" sizes="128x128">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-180.png" sizes="180x180">
    <link rel="icon" media="(prefers-color-scheme: dark)" href="/images/favicon-dark-192.png" sizes="192x192">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  
  
    
<div id="banner" class="">
  <img src="/1.jpg" itemprop="image">
  <div id="banner-dim"></div>
</div>
 
   
  <div id="main-grid" class="  ">
    <div id="nav" class=""  >
      <navbar id="navbar">
  <nav id="title-nav">
    <a href="/">
      <div id="vivia-logo">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
      </div>
      <div>Hexo </div>
    </a>
  </nav>
  <nav id="main-nav">
    
      <a class="main-nav-link" href="/">Home</a>
    
      <a class="main-nav-link" href="/archives">Archives</a>
    
      <a class="main-nav-link" href="/about">About</a>
    
  </nav>
  <nav id="sub-nav">
    <a id="theme-btn" class="nav-icon">
      <span class="light-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M438.5-829.913v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-829.913Zm0 747.826v-48q0-17.452 11.963-29.476 11.964-12.024 29.326-12.024 17.363 0 29.537 12.024t12.174 29.476v48q0 17.452-11.963 29.476-11.964 12.024-29.326 12.024-17.363 0-29.537-12.024T438.5-82.087ZM877.913-438.5h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537t29.476-12.174h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T877.913-438.5Zm-747.826 0h-48q-17.452 0-29.476-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T82.087-521.5h48q17.452 0 29.476 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T130.087-438.5Zm660.174-290.87-34.239 32q-12.913 12.674-29.565 12.174-16.653-.5-29.327-13.174-12.674-12.673-12.554-28.826.12-16.152 12.794-28.826l33-35q12.913-12.674 30.454-12.674t30.163 12.847q12.709 12.846 12.328 30.826-.38 17.98-13.054 30.653ZM262.63-203.978l-32 34q-12.913 12.674-30.454 12.674t-30.163-12.847q-12.709-12.846-12.328-30.826.38-17.98 13.054-30.653l33.239-31q12.913-12.674 29.565-12.174 16.653.5 29.327 13.174 12.674 12.673 12.554 28.826-.12 16.152-12.794 28.826Zm466.74 33.239-32-33.239q-12.674-12.913-12.174-29.565.5-16.653 13.174-29.327 12.673-12.674 28.826-13.054 16.152-.38 28.826 12.294l35 33q12.674 12.913 12.674 30.454t-12.847 30.163q-12.846 12.709-30.826 12.328-17.98-.38-30.653-13.054ZM203.978-697.37l-34-33q-12.674-12.913-13.174-29.945-.5-17.033 12.174-29.707t31.326-13.293q18.653-.62 31.326 13.054l32 34.239q11.674 12.913 11.174 29.565-.5 16.653-13.174 29.327-12.673 12.674-28.826 12.554-16.152-.12-28.826-12.794ZM480-240q-100 0-170-70t-70-170q0-100 70-170t170-70q100 0 170 70t70 170q0 100-70 170t-170 70Zm-.247-82q65.703 0 111.475-46.272Q637-414.544 637-480.247t-45.525-111.228Q545.95-637 480.247-637t-111.475 45.525Q323-545.95 323-480.247t45.525 111.975Q414.05-322 479.753-322ZM481-481Z"/></svg></span>
      <span class="dark-mode-icon"><svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M480.239-116.413q-152.63 0-258.228-105.478Q116.413-327.37 116.413-480q0-130.935 77.739-227.435t206.304-125.043q43.022-9.631 63.87 10.869t3.478 62.805q-8.891 22.043-14.315 44.463-5.424 22.42-5.424 46.689 0 91.694 64.326 155.879 64.325 64.186 156.218 64.186 24.369 0 46.978-4.946 22.609-4.945 44.413-14.076 42.826-17.369 62.967 1.142 20.142 18.511 10.511 61.054Q807.174-280 712.63-198.206q-94.543 81.793-232.391 81.793Zm0-95q79.783 0 143.337-40.217 63.554-40.218 95.793-108.283-15.608 4.044-31.097 5.326-15.49 1.283-31.859.805-123.706-4.066-210.777-90.539-87.071-86.473-91.614-212.092-.24-16.369.923-31.978 1.164-15.609 5.446-30.978-67.826 32.478-108.282 96.152Q211.652-559.543 211.652-480q0 111.929 78.329 190.258 78.329 78.329 190.258 78.329ZM466.13-465.891Z"/></svg></span>
    </a>
    
      <a id="nav-rss-link" class="nav-icon mobile-hide" href="/atom.xml" title="RSS Feed">
        <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M198-120q-25.846 0-44.23-18.384-18.384-18.385-18.384-44.23 0-25.846 18.384-44.23 18.384-18.385 44.23-18.385 25.846 0 44.23 18.385 18.384 18.384 18.384 44.23 0 25.845-18.384 44.23Q223.846-120 198-120Zm538.385 0q-18.846 0-32.923-13.769-14.076-13.769-15.922-33.23-8.692-100.616-51.077-188.654-42.385-88.039-109.885-155.539-67.5-67.501-155.539-109.885Q283-663.462 182.385-672.154q-19.461-1.846-33.23-16.23-13.769-14.385-13.769-33.846t14.076-32.922q14.077-13.461 32.923-12.23 120.076 8.692 226.038 58.768 105.961 50.077 185.73 129.846 79.769 79.769 129.846 185.731 50.077 105.961 58.769 226.038 1.231 18.846-12.538 32.922Q756.461-120 736.385-120Zm-252 0q-18.231 0-32.423-13.461t-18.653-33.538Q418.155-264.23 348.886-333.5q-69.27-69.27-166.501-84.423-20.077-4.462-33.538-18.961-13.461-14.5-13.461-33.346 0-19.076 13.884-33.23 13.884-14.153 33.115-10.922 136.769 15.384 234.384 112.999 97.615 97.615 112.999 234.384 3.231 19.23-10.538 33.115Q505.461-120 484.385-120Z"/></svg>
      </a>
    
    <div id="nav-menu-btn" class="nav-icon">
      <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 -960 960 960" width="20"><path d="M177.37-252.282q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Zm0-186.218q-17.453 0-29.477-11.963-12.024-11.964-12.024-29.326 0-17.363 12.024-29.537T177.37-521.5h605.26q17.453 0 29.477 11.963 12.024 11.964 12.024 29.326 0 17.363-12.024 29.537T782.63-438.5H177.37Zm0-186.217q-17.453 0-29.477-11.964-12.024-11.963-12.024-29.326t12.024-29.537q12.024-12.174 29.477-12.174h605.26q17.453 0 29.477 11.964 12.024 11.963 12.024 29.326t-12.024 29.537q-12.024 12.174-29.477 12.174H177.37Z"/></svg>
    </div>
  </nav>
</navbar>
<div id="nav-dropdown" class="hidden">
  <div id="dropdown-link-list">
    
      <a class="nav-dropdown-link" href="/">Home</a>
    
      <a class="nav-dropdown-link" href="/archives">Archives</a>
    
      <a class="nav-dropdown-link" href="/about">About</a>
    
    
      <a class="nav-dropdown-link" href="/atom.xml" title="RSS Feed">RSS</a>
     
    </div>
</div>
<script>
  let dropdownBtn = document.getElementById("nav-menu-btn");
  let dropdownEle = document.getElementById("nav-dropdown");
  dropdownBtn.onclick = function() {
    dropdownEle.classList.toggle("hidden");
  }
</script>
    </div>
    <div id="sidebar-wrapper">
      <sidebar id="sidebar">
  
    <div class="widget-wrap">
  <div class="info-card">
    <div class="avatar">
      
        <image src=/2.jpg></image>
      
      <div class="img-dim"></div>
    </div>
    <div class="info">
      <div class="username">Thrinisty </div>
      <div class="dot"></div>
      <div class="subtitle">苦逼大学生来的 </div>
      <div class="link-list">
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://twitter.com" title="Twitter"><i class="fa-brands fa-twitter"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://store.steampowered.com" title="Steam"><i class="fa-brands fa-steam"></i></a>
        
          <a class="link-btn" target="_blank" rel="noopener" href="https://github.com" title="GitHub"><i class="fa-brands fa-github"></i></a>
         
      </div>  
    </div>
  </div>
</div>

  
  <div class="sticky">
    
      



    
      

    
  </div>
</sidebar>
    </div>
    <div id="content-body">
       


<article id="post-Java多用户通讯系统设计" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    
   
  <div class="article-inner">
    <div class="article-main">
      <header class="article-header">
        
<div class="main-title-bar">
  <div class="main-title-dot"></div>
  
    
      <h1 class="p-name article-title" itemprop="headline name">
        Java多用户通讯系统设计
      </h1>
    
  
</div>

        <div class='meta-info-bar'>
          <div class="meta-info">
  <time class="dt-published" datetime="2025-03-17T07:08:00.000Z" itemprop="datePublished">2025-03-17</time>
</div>
          <div class="need-seperator meta-info">
            <div class="meta-cate-flex">
  
    Uncategorized 
   
</div>
  
          </div>
          <div class="wordcount need-seperator meta-info">
            21k words 
          </div>
        </div>
        
      </header>
      <div class="e-content article-entry" itemprop="articleBody">
        
          <h1 id="多用户通信系统设计"><a href="#多用户通信系统设计" class="headerlink" title="多用户通信系统设计"></a>多用户通信系统设计</h1><p><a target="_blank" rel="noopener" href="https://github.com/thrinisty/Multi-user-communication-system.git">https://github.com/thrinisty/Multi-user-communication-system.git</a></p>
<h2 id="功能实现"><a href="#功能实现" class="headerlink" title="功能实现"></a>功能实现</h2><p>1.用户登录</p>
<p>2.拉取用户列表</p>
<p>3.私聊</p>
<p>4.群聊</p>
<p>5.发文件</p>
<h2 id="思路分析"><a href="#思路分析" class="headerlink" title="思路分析"></a>思路分析</h2><p>当客户端与服务端产生链接的时候，服务端会产生一个socket，必须要创建一个线程来持有并管理产生的socket</p>
<p>服务器端的多个线程需要一个管理线程的集合，用以后续的服务器推送新闻</p>
<p>每一个客户端也可能会创建多个线程，和服务器端通信，需要客户端线程的管理集合（hashmap）</p>
<p><img src="/../images/66.png" alt="66"></p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><p>1.当客户端连接到服务器时得到了socket</p>
<p>2.启动了一个线程，该线程持有socket，socket是线程的属性</p>
<p>3.为了管理线程，用集合hashmap管理线程，将线程放入集合</p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>1.和服务端通信的时候使用对象的方式，可以使用对象流来进行读写</p>
<p>2.当客户端连接到服务器端时，会得到socket</p>
<p>3.启动一个线程，该线程持有socket</p>
<p>4.为了管理线程，用集合hashmap管理线程，将线程放入集合</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="1-用户登录"><a href="#1-用户登录" class="headerlink" title="1.用户登录"></a>1.用户登录</h3><p>创建User对象，表示一个用户信息（如果对象要在IO中传输，对象需要进行序列化）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqcommon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示一个用户信息</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;<span class="comment">//增强兼容性</span></span><br><span class="line">    <span class="keyword">private</span> String userId;<span class="comment">//用户名</span></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    User(String userId, String password) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUserId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserId</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建Message对象，表示客户端和服务端通信时的消息对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqcommon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="comment">//表示客户端和服务端通信时的消息对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> String sender;<span class="comment">//发送者</span></span><br><span class="line">    <span class="keyword">private</span> String getter;<span class="comment">//接收者</span></span><br><span class="line">    <span class="keyword">private</span> String content;<span class="comment">//消息内容</span></span><br><span class="line">    <span class="keyword">private</span> String sendTime;<span class="comment">//发送时间</span></span><br><span class="line">    <span class="keyword">private</span> String mesType;<span class="comment">//消息类型【可以在接口定义消息类型】</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMesType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mesType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMesType</span><span class="params">(String mesType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mesType = mesType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSender</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSender</span><span class="params">(String sender)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sender = sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getGetter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setGetter</span><span class="params">(String getter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.getter = getter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.content = content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getSendTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sendTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSendTime</span><span class="params">(String sendTime)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sendTime = sendTime;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MessageType接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqcommon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_LOGIN_SUCCEED</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;<span class="comment">//登录成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_LOGIN_FAIL</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;<span class="comment">//登录失败</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h4><p>客户端聊天的菜单界面（内部逻辑）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqcommon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QQview</span> &#123;</span><br><span class="line">    <span class="comment">//显示主菜单</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">loop</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">scanner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">QQview</span> <span class="variable">qqview</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QQview</span>();</span><br><span class="line">        qqview.mainMenu();</span><br><span class="line">        System.out.println(<span class="string">&quot;退出聊天系统&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mainMenu</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (loop) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;==========欢迎来到网络登录系统==========&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;\t\t 1 登陆系统&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;\t\t 9 退出系统&quot;</span>);</span><br><span class="line">            System.out.print(<span class="string">&quot;请输入1-9： &quot;</span>);</span><br><span class="line">            key = scanner.next();</span><br><span class="line">            <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;登陆系统&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;请输入用户号码： &quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                    System.out.println(<span class="string">&quot;请输入用户密码： &quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">                    <span class="comment">//将用户密码和用户名称发送到服务端，暂定</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;==========登录成功==========&quot;</span>);</span><br><span class="line">                        <span class="keyword">while</span> (loop) &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;==========网络通讯系统==========&quot;</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;欢迎用户&quot;</span> + userId);</span><br><span class="line">                            System.out.println(<span class="string">&quot;\t\t 1 显示在线用户列表&quot;</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;\t\t 2 群发消息&quot;</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;\t\t 3 私聊消息&quot;</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;\t\t 4 发送文件&quot;</span>);</span><br><span class="line">                            System.out.println(<span class="string">&quot;\t\t 9 退出系统&quot;</span>);</span><br><span class="line">                            System.out.print(<span class="string">&quot;请输入1-9 &quot;</span>);</span><br><span class="line">                            key = scanner.next();</span><br><span class="line">                            <span class="keyword">switch</span> (key) &#123;</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">                                    System.out.println(<span class="string">&quot;显示在线用户列表&quot;</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">                                    System.out.println(<span class="string">&quot;群发消息&quot;</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">                                    System.out.println(<span class="string">&quot;私聊消息&quot;</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&quot;4&quot;</span>:</span><br><span class="line">                                    System.out.println(<span class="string">&quot;发送文件&quot;</span>);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                <span class="keyword">case</span> <span class="string">&quot;9&quot;</span>:</span><br><span class="line">                                    System.out.println(<span class="string">&quot;退出系统&quot;</span>);</span><br><span class="line">                                    loop = <span class="literal">false</span>;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;==========登陆失败==========&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">&quot;9&quot;</span>:</span><br><span class="line">                    System.out.println(<span class="string">&quot;==========登陆退出==========&quot;</span>);</span><br><span class="line">                    loop = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>线程服务类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqclient.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.Message;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.MessageType;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserClientService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();<span class="comment">//因为要在其他地方使用属性</span></span><br><span class="line">    <span class="keyword">private</span> Socket socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Socket <span class="title function_">getSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSocket</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用以判断是否登录正确，消息来自于服务端按</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkUser</span><span class="params">(String userId, String password)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        u.setUserId(userId);</span><br><span class="line">        u.setPassword(password);</span><br><span class="line">        <span class="comment">//连接到服务器，发送u对象</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">Socket</span>(InetAddress.getByName(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">9999</span>);</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">            oos.writeObject(u);<span class="comment">//发送User对象</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">//读取收到的Message对象</span></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">            <span class="type">Message</span> <span class="variable">ms</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">            <span class="keyword">if</span>(ms.getMesType().equals(MessageType.MESSAGE_LOGIN_SUCCEED))&#123;</span><br><span class="line">                <span class="comment">//创建一个和服务器端保持通信的线程-&gt;创建线程类 ClientConnectServerThread</span></span><br><span class="line">                <span class="type">ClientConnectServerThread</span> <span class="variable">clientConnectServerThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClientConnectServerThread</span>(socket);</span><br><span class="line">                clientConnectServerThread.start();</span><br><span class="line">                <span class="comment">//为了方便管理，将线程放入一个集合中ManageClientConnectServerThread</span></span><br><span class="line">                ManageClientConnectServerThread.addClientConnectServerThread(userId, clientConnectServerThread);</span><br><span class="line">                b = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//登陆失败不启动线程，关闭没有用到的socket</span></span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中创建的线程是一个类，含有socket对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqserver.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.Message;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.MessageType;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端监听9999端口，等待客户端连接，保持通信</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QQServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QQServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;服务端在9999监听...&quot;</span>);</span><br><span class="line">            ss = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">9999</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> ss.accept();</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User) ois.readObject();</span><br><span class="line">                <span class="comment">//将数据进行验证，但是这没有数据库，模拟一个验证流程</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">                <span class="keyword">if</span>(u.getUserId().equals(<span class="string">&quot;100&quot;</span>) &amp;&amp; u.getPassword().equals(<span class="string">&quot;123456&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">//登陆成功，向客户端发送连接信息</span></span><br><span class="line">                    message.setMesType(MessageType.MESSAGE_LOGIN_SUCCEED);</span><br><span class="line">                    oos.writeObject(message);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//创建线程持有socket对象</span></span><br><span class="line">                    <span class="type">ServerConnectClientThread</span> <span class="variable">serverConnectClientThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerConnectClientThread</span>(socket, u.getUserId());</span><br><span class="line">                    serverConnectClientThread.start();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将线程放入集合</span></span><br><span class="line">                    ManageClientThreads.addClientThread(u.getUserId(),serverConnectClientThread);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//登陆失败</span></span><br><span class="line">                    System.out.println(<span class="string">&quot;用户 &quot;</span> + u.getUserId() + <span class="string">&quot;登录无效&quot;</span>);</span><br><span class="line">                    message.setMesType(MessageType.MESSAGE_LOGIN_FAIL);</span><br><span class="line">                    oos.writeObject(message);</span><br><span class="line">                    socket.close();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//如果服务端退出循环，服务器端不再监听</span></span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                ss.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;客户端线程，等待读取服务器数据&quot;</span>);</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();<span class="comment">//没有发送对象 线程发送阻塞</span></span><br><span class="line">                <span class="comment">//其余处理</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Socket <span class="title function_">getSocket</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> socket;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSocket</span><span class="params">(Socket socket)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>又在服务类里面创建了一个现成的集合对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqclient.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">//管理客户端带服务端线程的一个类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ManageClientConnectServerThread</span> &#123;</span><br><span class="line">    <span class="comment">//把多个线程放入一个hashmap集合中，key是用户id， value是线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap&lt;String, ClientConnectServerThread&gt; hm = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将线程加入</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addClientConnectServerThread</span><span class="params">(String userId, ClientConnectServerThread clientConnectServerThread)</span> &#123;</span><br><span class="line">        hm.put(userId, clientConnectServerThread);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//用id取出线程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ClientConnectServerThread <span class="title function_">getClientConnectServerThread</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hm.get(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h4><p>基本的服务流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqserver.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.Message;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.MessageType;</span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">//服务端监听9999端口，等待客户端连接，保持通信</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">QQServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">ServerSocket</span> <span class="variable">ss</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">QQServer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;服务端在9999监听...&quot;</span>);</span><br><span class="line">            ss = <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(<span class="number">9999</span>);</span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> ss.accept();</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line"></span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">                <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> (User) ois.readObject();</span><br><span class="line">                <span class="comment">//将数据进行验证，但是这没有数据库，模拟一个验证流程 在后续更改为checkUser()</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">                <span class="keyword">if</span>(u.getUserId().equals(<span class="string">&quot;100&quot;</span>) &amp;&amp; u.getPassword().equals(<span class="string">&quot;123456&quot;</span>)) &#123;</span><br><span class="line">                    <span class="comment">//登陆成功，向客户端发送连接信息</span></span><br><span class="line">                    message.setMesType(MessageType.MESSAGE_LOGIN_SUCCEED);</span><br><span class="line">                    oos.writeObject(message);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//创建线程持有socket对象</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将线程放入集合</span></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//登陆失败</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的创建线程对象如下，重写了线程运行的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqserver.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.npu.qqcommon.Message;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该类对该类的对象和客户端保持连接，拥有一个socket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServerConnectClientThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">userId</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//连接到服务器的用户id</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServerConnectClientThread</span><span class="params">(Socket socket, String userId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.socket = socket;</span><br><span class="line">        <span class="built_in">this</span>.userId = userId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;正在尝试读取客户端数据&quot;</span>);</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">                <span class="comment">//等待使用的数据</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在服务器中创建线程的时候将线程放入一个集合中统一管理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.npu.qqserver.server;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该类用于管理与客户端通讯的线程</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ManageClientThreads</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, ServerConnectClientThread&gt; hm = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addClientThread</span><span class="params">(String userId, ServerConnectClientThread ServerConnectClientThread)</span> &#123;</span><br><span class="line">        hm.put(userId, ServerConnectClientThread);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ServerConnectClientThread <span class="title function_">getClientThread</span><span class="params">(String userId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hm.get(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="判断账户密码"><a href="#判断账户密码" class="headerlink" title="判断账户密码"></a>判断账户密码</h4><p>在上述中我们服务器判断账号密码是否合法采用的是账户为100 密码为123456</p>
<p>现在进行功能上的修改：更改为指定的数个账户</p>
<p>判断方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">checkUser</span><span class="params">(String userId, String password)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> validUsers.get(userId);</span><br><span class="line">        <span class="keyword">if</span>(user == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;用户id错误，不存在用户&quot;</span> + userId);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!password.equals(user.getPassword())) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户密码错误&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中对应的hashmap集合（在静态中初始化一些用户）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, User&gt; validUsers = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">   <span class="keyword">static</span> &#123;</span><br><span class="line">       validUsers.put(<span class="string">&quot;100&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">       validUsers.put(<span class="string">&quot;200&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">       validUsers.put(<span class="string">&quot;300&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">       validUsers.put(<span class="string">&quot;400&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;100&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">       validUsers.put(<span class="string">&quot;李昊轩&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;李昊轩&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">       validUsers.put(<span class="string">&quot;王凌&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;王凌&quot;</span>, <span class="string">&quot;123456&quot;</span>));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>至此多用户登录功能已经完成，下面进入拉取用户列表的实现</p>
<p><img src="/../images/67.png" alt="67"></p>
<h3 id="2-拉取用户列表"><a href="#2-拉取用户列表" class="headerlink" title="2.拉取用户列表"></a>2.拉取用户列表</h3><h4 id="接口扩展"><a href="#接口扩展" class="headerlink" title="接口扩展"></a>接口扩展</h4><p>扩展MessageType接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageType</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_LOGIN_SUCCEED</span> <span class="operator">=</span> <span class="string">&quot;1&quot;</span>;<span class="comment">//登录成功</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_LOGIN_FAIL</span> <span class="operator">=</span> <span class="string">&quot;2&quot;</span>;<span class="comment">//登录失败</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_COMM_MES</span> <span class="operator">=</span> <span class="string">&quot;3&quot;</span>;<span class="comment">//普通信息包</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_GET_ONLINE_FRIEND</span> <span class="operator">=</span> <span class="string">&quot;4&quot;</span>;<span class="comment">//要求返回在线用户列表</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_RET_ONLINE_FRIEND</span> <span class="operator">=</span> <span class="string">&quot;5&quot;</span>;<span class="comment">//返回在线用户列表</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">MESSAGE_CLIENT_EXIT</span> <span class="operator">=</span> <span class="string">&quot;6&quot;</span>;<span class="comment">//客户端请求退出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="客户端-2"><a href="#客户端-2" class="headerlink" title="客户端"></a>客户端</h4><p>在客户端菜单栏中调用特定方法发送给服务器用户列表请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (key) &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&quot;1&quot;</span>:</span><br><span class="line">     System.out.println(<span class="string">&quot;显示在线用户列表&quot;</span>);</span><br><span class="line">	userClientService.onlineFriendList();</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>客户端服务类的发送请求方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onlineFriendList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        ms.setMesType(MessageType.MESSAGE_GET_ONLINE_FRIEND);</span><br><span class="line">        <span class="comment">//发送给服务器，先得到当前线程的socket对应的输出流</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(ManageClientConnectServerThread</span><br><span class="line">                    .getClientConnectServerThread(u.getUserId()).getSocket().getOutputStream());</span><br><span class="line">            oos.writeObject(ms);<span class="comment">//发送请求</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在客户端线程中如果收到的message类型是在线用户列进行的相关处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//因为持续通信持续循环</span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;客户端线程，等待读取服务器数据&quot;</span>);</span><br><span class="line">                <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">                <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();<span class="comment">//没有发送对象 线程发送阻塞</span></span><br><span class="line">                <span class="comment">//其余处理,后续需要使用</span></span><br><span class="line">                <span class="comment">//判断message类型，处理后续内容</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//当读到用户列表请求</span></span><br><span class="line">                <span class="keyword">if</span>(message.getMesType().equals(MessageType.MESSAGE_RET_ONLINE_FRIEND)) &#123;</span><br><span class="line">                    <span class="comment">//取出在线列表然后返回</span></span><br><span class="line">                    String[] onlineUsers = message.getContent().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;======当前在线用户======&quot;</span>);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; onlineUsers.length; i++) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;用户：&quot;</span> + onlineUsers[i]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;暂时不处理&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h4><p>在线程中处理收到的Message信息</p>
<p>如果收到的Message信息是请求获取列表，则构造信息返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;用户id &quot;</span> + userId);</span><br><span class="line">            System.out.println(<span class="string">&quot;正在尝试读取客户端数据&quot;</span>);</span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(socket.getInputStream());</span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> (Message) ois.readObject();</span><br><span class="line">            <span class="comment">//等待使用的数据</span></span><br><span class="line">            <span class="comment">//更具Message类型处理后续</span></span><br><span class="line">            <span class="keyword">if</span>(message.getMesType().equals(MessageType.MESSAGE_GET_ONLINE_FRIEND)) &#123;</span><br><span class="line">                <span class="comment">//客户端要求返回在线用户列表</span></span><br><span class="line">                System.out.println(userId + <span class="string">&quot; 需要在线列表&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">onlineUser</span> <span class="operator">=</span> ManageClientThreads.getOnlineUser();</span><br><span class="line">                <span class="comment">//拿到了信息构造一个Message</span></span><br><span class="line">                <span class="type">Message</span> <span class="variable">message2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">                message2.setMesType(MessageType.MESSAGE_RET_ONLINE_FRIEND);</span><br><span class="line">                message2.setContent(onlineUser);</span><br><span class="line">                message2.setGetter(message.getSender());</span><br><span class="line">                <span class="comment">//写入Message</span></span><br><span class="line">                <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">                oos.writeObject(message2);</span><br><span class="line">                System.out.println(<span class="string">&quot;已发送在线用户列表给 &quot;</span> + userId);</span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;收到服务器消息，暂不处理&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-5-无异常退出"><a href="#2-5-无异常退出" class="headerlink" title="2.5.无异常退出"></a>2.5.无异常退出</h3><p>问题一：当在二级菜单 输入设置为9 退出的时候也没办法正常退出，因为服务器通讯的线程没有结束</p>
<p>问题二：当客户端断开连接的时候，服务线程还在不断地尝试获取客户端消息，造成了报错</p>
<p>我们需要一个好的方法进行无异常退出</p>
<p>解决方法：</p>
<h4 id="客户端-3"><a href="#客户端-3" class="headerlink" title="客户端"></a>客户端</h4><p>客户端没有移除集合中的线程是因为最终客户端只拥有一个线程</p>
<p>1.在主函数中调用方法给服务器端发送一个退出的Message对象</p>
<p>2.调用客户端 System.exit(0) 进行退出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Message</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        ms.setMesType(MessageType.MESSAGE_CLIENT_EXIT);</span><br><span class="line">        ms.setSender(u.getUserId());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(socket.getOutputStream());</span><br><span class="line">            oos.writeObject(ms);</span><br><span class="line">            System.out.println(<span class="string">&quot;退出系统&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">0</span>);<span class="comment">//结束进程</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h4 id="服务端-2"><a href="#服务端-2" class="headerlink" title="服务端"></a>服务端</h4><p>1.接收message消息，当消息为退出的时候执行下述步骤</p>
<p>2.移除集合中的对应线程</p>
<p>3.服务器端关闭线程持有的socket,再退出线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(message.getMesType().equals(MessageType.MESSAGE_CLIENT_EXIT)) &#123;</span><br><span class="line">       System.out.println(userId + <span class="string">&quot; 准备退出&quot;</span>);</span><br><span class="line">       <span class="comment">//将客户端的线程从集合中删除</span></span><br><span class="line">       ManageClientThreads.removeClientThread(userId);</span><br><span class="line">       socket.close();</span><br><span class="line">       <span class="comment">//退出while循环</span></span><br><span class="line">       <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/../images/68.png" alt="68"></p>
<p><img src="/../images/69.png" alt="69"></p>
<h3 id="3-私聊"><a href="#3-私聊" class="headerlink" title="3.私聊"></a>3.私聊</h3><h4 id="客户端-4"><a href="#客户端-4" class="headerlink" title="客户端"></a>客户端</h4><p>1.接收用户希望给某个其他的在线用户聊天内容</p>
<p>2.将消息构建成Message对象，通过对应的socket发送给服务器</p>
<p>3.在通讯线程中收到其他的客户端发送的消息并显示</p>
<p>在菜单中调用方法发送私聊</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;3&quot;</span>:</span><br><span class="line">    System.out.println(<span class="string">&quot;私聊消息&quot;</span>);</span><br><span class="line">    System.out.print(<span class="string">&quot;请输入要聊天的用户: &quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">getterId</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    System.out.print(<span class="string">&quot;请输入想说的话&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    <span class="comment">//编写一个方法完成发送</span></span><br><span class="line">    messageClientService.sendMessageToOne(content, userId, getterId);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>私聊实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToOne</span><span class="params">(String content, String senderId, String getterId)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    ms.setMesType(MessageType.MESSAGE_COMM_MES);<span class="comment">//设置为普通消息类型</span></span><br><span class="line">    ms.setSender(senderId);</span><br><span class="line">    ms.setGetter(getterId);</span><br><span class="line">    ms.setContent(content);</span><br><span class="line">    System.out.println(senderId + <span class="string">&quot;对&quot;</span> + getterId + <span class="string">&quot;私聊 内容为：&quot;</span> + content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(ManageClientConnectServerThread</span><br><span class="line">                .getClientConnectServerThread(senderId).getSocket().getOutputStream());</span><br><span class="line">        oos.writeObject(ms);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>收到私聊消息后显示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(message.getMesType().equals(MessageType.MESSAGE_COMM_MES)) &#123;</span><br><span class="line">    <span class="comment">//将消息显示出来</span></span><br><span class="line">    System.out.println(<span class="string">&quot;\n收到来自 &quot;</span> + message.getSender() + <span class="string">&quot; 的消息，内容如下：&quot;</span>);</span><br><span class="line">    System.out.println(message.getContent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器-1"><a href="#服务器-1" class="headerlink" title="服务器"></a>服务器</h4><p>1.可以读取到客户端发送给某个客户的消息</p>
<p>2.从管理的线程集合中根据发送的目标用户id，获取socket</p>
<p>3.将message对象转发给客户</p>
<p>服务器只完成转发的工作，当收到转发消息时转发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(message.getMesType().equals(MessageType.MESSAGE_COMM_MES)) &#123;</span><br><span class="line">    <span class="comment">//根据收到的消息中获取发送的对象进行转发</span></span><br><span class="line">    <span class="type">ServerConnectClientThread</span> <span class="variable">serverConnectClientThread</span> <span class="operator">=</span></span><br><span class="line">            ManageClientThreads.getClientThread(message.getGetter());</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(serverConnectClientThread</span><br><span class="line">            .getSocket().getOutputStream());</span><br><span class="line">    oos.writeObject(message);<span class="comment">//发送，如果客户不在线可以保存到数据库中</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-群聊"><a href="#4-群聊" class="headerlink" title="4.群聊"></a>4.群聊</h3><p>大体和私聊类似</p>
<p>在Message消息类型补充</p>
<p>String MESSAGE_TO_ALL_MES &#x3D; “7”;&#x2F;&#x2F;群发消息</p>
<h4 id="客户端-5"><a href="#客户端-5" class="headerlink" title="客户端"></a>客户端</h4><p>菜单调用功能方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;2&quot;</span>:</span><br><span class="line">    System.out.println(<span class="string">&quot;请输入群发的话，内容将被发给所有的在线用户&quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    <span class="comment">//调用方法将字符串发送给服务器进行广播</span></span><br><span class="line">    messageClientService.sendMessageToAll(s, userId);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>群发消息到服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessageToAll</span><span class="params">(String content, String senderId)</span> &#123;</span><br><span class="line">    <span class="type">Message</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">    ms.setMesType(MessageType.MESSAGE_TO_ALL_MES);<span class="comment">//设置为普通消息类型</span></span><br><span class="line">    ms.setSender(senderId);</span><br><span class="line">    ms.setContent(content);</span><br><span class="line">    System.out.println(senderId + <span class="string">&quot;群发消息，内容为：&quot;</span> + content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(ManageClientConnectServerThread</span><br><span class="line">                .getClientConnectServerThread(senderId).getSocket().getOutputStream());</span><br><span class="line">        oos.writeObject(ms);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接收到群发消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (message.getMesType().equals(MessageType.MESSAGE_TO_ALL_MES)) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;\n收到来自 &quot;</span> + message.getSender() + <span class="string">&quot; 群发的消息，内容如下：&quot;</span>);</span><br><span class="line">    System.out.println(message.getContent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务端-3"><a href="#服务端-3" class="headerlink" title="服务端"></a>服务端</h4><p>当收到消息为群发时，中介群发给除发送者外的所有用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (message.getMesType().equals(MessageType.MESSAGE_TO_ALL_MES)) &#123;</span><br><span class="line">    <span class="comment">//需要遍历线程的管理集合逐个发送</span></span><br><span class="line">    HashMap&lt;String, ServerConnectClientThread&gt; hm = ManageClientThreads.getHm();</span><br><span class="line">    Iterator&lt;String&gt; interator = hm.keySet().iterator();</span><br><span class="line">    <span class="keyword">while</span> (interator.hasNext()) &#123;</span><br><span class="line">        <span class="comment">//取出在线用户ID</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">onLineUserId</span> <span class="operator">=</span> interator.next().toString();</span><br><span class="line">        <span class="keyword">if</span>(!onLineUserId.equals(message.getSender())) &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(hm.get</span><br><span class="line">                    (onLineUserId).getSocket().getOutputStream());</span><br><span class="line">                oos.writeObject(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此群发消息功能完成</p>
<p><img src="/../images/70.png" alt="70"></p>
<h3 id="5-发文件"><a href="#5-发文件" class="headerlink" title="5.发文件"></a>5.发文件</h3><p>首先我们要扩展Message类的定义，在类中添加bytes数组，以及一些必要的成员变量，拓展MessageType，定义新的消息类型</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">byte</span>[] fileBytes;<span class="comment">//用于发送文件</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">fileSize</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//文件大小</span></span><br><span class="line"><span class="keyword">private</span> String dest;<span class="comment">//将文件传输到的位置</span></span><br><span class="line"><span class="keyword">private</span> String src;<span class="comment">//发送的文件路径</span></span><br></pre></td></tr></table></figure>

<h4 id="客户端-6"><a href="#客户端-6" class="headerlink" title="客户端"></a>客户端</h4><p>1.将指定路径下的文件输出流转换为字节数组</p>
<p>2.将字节数组封装在message对象中</p>
<p>3.将message对象发送，在服务器进行相应处理</p>
<p>4.接收到文件message对象的时候将message对象中的字节数组运用文件输入流存储至指定的目录下</p>
<p>在菜单栏中调用文件类的功能方法，完成向服务器传送message消息（其中包含了文件的内容）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;4&quot;</span>:</span><br><span class="line">    System.out.print(<span class="string">&quot;请输入发送对象 &quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">target</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    System.out.print(<span class="string">&quot;请输入要发送的文件路径 &quot;</span>);</span><br><span class="line">    <span class="comment">//e:\\1.jpg  e:\\2.jpg</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    System.out.print(<span class="string">&quot;请输入保存至对方电脑的文件路径 &quot;</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">savePath</span> <span class="operator">=</span> scanner.next();</span><br><span class="line">    fileClientService.sendFileToOne(filePath, savePath, userId, target);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>sendFileToOne具体实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileClientService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendFileToOne</span><span class="params">(String src, String dest, String senderId, String getterId)</span> &#123;</span><br><span class="line">        <span class="comment">//构造message信息</span></span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Message</span>();</span><br><span class="line">        message.setMesType(MessageType.MESSAGE_FILE_MES);</span><br><span class="line">        message.setSender(senderId);</span><br><span class="line">        message.setDest(dest);</span><br><span class="line">        message.setGetter(getterId);</span><br><span class="line">        message.setSrc(src);</span><br><span class="line">        <span class="comment">//读取文件内容</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">byte</span>[] fileBytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>)<span class="keyword">new</span> <span class="title class_">File</span>(src).length()];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            fileInputStream = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(src);</span><br><span class="line">            fileInputStream.read(fileBytes);</span><br><span class="line">            <span class="comment">//将字节数组放入message</span></span><br><span class="line">            message.setFileBytes(fileBytes);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    fileInputStream.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(ManageClientConnectServerThread</span><br><span class="line">                    .getClientConnectServerThread(senderId).getSocket().getOutputStream());</span><br><span class="line">            oos.writeObject(message);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;发送目录 &quot;</span> + message.getSrc() + <span class="string">&quot;目录文件至 &quot;</span></span><br><span class="line">                + message.getGetter() + <span class="string">&quot; 的目录 &quot;</span> + message.getDest());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>运用线程来接收来自服务器的文件相关message，将其中的数据保存在指定目录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (message.getMesType().equals(MessageType.MESSAGE_FILE_MES)) &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;\n收到来自 &quot;</span> + message.getSender() + <span class="string">&quot; 的文件&quot;</span>);</span><br><span class="line">    <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(message.getDest());</span><br><span class="line">    fos.write(message.getFileBytes());</span><br><span class="line">    fos.close();</span><br><span class="line">    System.out.println(<span class="string">&quot;文件保存在目录 &quot;</span> + message.getDest());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="服务器-2"><a href="#服务器-2" class="headerlink" title="服务器"></a>服务器</h4><p>1.接收到message对象</p>
<p>2.得到message对象中的getter，用他的userId获取通信线程</p>
<p>3.将message对象转发给指定的用户</p>
<p>和私聊类似，完成message转发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (message.getMesType().equals(MessageType.MESSAGE_FILE_MES)) &#123;</span><br><span class="line">    <span class="comment">//根据getterid选取集合中的对应线程得到socket用以转发文件消息</span></span><br><span class="line">    <span class="type">ServerConnectClientThread</span> <span class="variable">serverConnectClientThread</span> <span class="operator">=</span></span><br><span class="line">            ManageClientThreads.getClientThread(message.getGetter());</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(serverConnectClientThread</span><br><span class="line">            .getSocket().getOutputStream());</span><br><span class="line">    oos.writeObject(message);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="/../images/71.png" alt="71"></p>
<p><img src="/../images/72.png" alt="72"></p>

        
      </div>

         
    </div>
    
     
  </div>
  
    
<nav id="article-nav">
  <a class="article-nav-btn left "
    
      href="/2025/03/20/Java%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0%EF%BC%88%E7%B1%BB%E6%96%B9%E6%B3%95%EF%BC%8C%E7%B1%BB%E5%8F%98%E9%87%8F%EF%BC%8C%E4%BB%A3%E7%A0%81%E5%9D%97%EF%BC%8C%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%EF%BC%8Cfinal%E5%85%B3%E9%94%AE%E5%AD%97%EF%BC%89/"
      title="Java课堂笔记（类方法，类变量，代码块，设计模式，final关键字）"
     >
    <i class="fa-solid fa-angle-left"></i>
    <p class="title-text">
      
        Java课堂笔记（类方法，类变量，代码块，设计模式，final关键字）
        
    </p>
  </a>
  <a class="article-nav-btn right "
    
      href="/2025/03/17/%E9%A1%B9%E7%9B%AE%E6%A0%87%E5%87%86%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B/"
      title="项目标准开发流程"
     >

    <p class="title-text">
      
        项目标准开发流程
        
    </p>
    <i class="fa-solid fa-angle-right"></i>
  </a>
</nav>


  
</article>





    </div>
    <div id="footer-wrapper">
      <footer id="footer">
  
  <div id="footer-info" class="inner">
    
    &copy; 2025 Thrinisty<br>
    Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & Theme <a target="_blank" rel="noopener" href="https://github.com/saicaca/hexo-theme-vivia">Vivia</a>
  </div>
</footer>

    </div>
    <div class="back-to-top-wrapper">
    <button id="back-to-top-btn" class="back-to-top-btn hide" onclick="topFunction()">
        <i class="fa-solid fa-angle-up"></i>
    </button>
</div>

<script>
    function topFunction() {
        window.scroll({ top: 0, behavior: 'smooth' });
    }
    let btn = document.getElementById('back-to-top-btn');
    function scrollFunction() {
        if (document.body.scrollTop > 600 || document.documentElement.scrollTop > 600) {
            btn.classList.remove('hide')
        } else {
            btn.classList.add('hide')
        }
    }
    window.onscroll = function() {
        scrollFunction();
    }
</script>

  </div>
  <script src="/js/light-dark-switch.js"></script>
</body>
</html>
